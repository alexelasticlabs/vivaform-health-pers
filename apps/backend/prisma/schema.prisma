generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum SubscriptionTier {
  FREE
  PREMIUM
}

enum UserRole {
  USER
  ADMIN
}

enum ActivityLevel {
  SEDENTARY
  LIGHT
  MODERATE
  ACTIVE
  ATHLETE
}

enum GoalType {
  LOSE_WEIGHT
  MAINTAIN_WEIGHT
  GAIN_WEIGHT
}

model User {
  id                  String               @id @default(cuid())
  email               String               @unique
  passwordHash        String
  name                String?
  role                UserRole             @default(USER)
  tier                SubscriptionTier     @default(FREE)
  emailVerified       Boolean              @default(false)
  emailVerifiedAt     DateTime?
  mustChangePassword  Boolean              @default(false)
  pushToken           String?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  profile             Profile?
  quizProfile         QuizProfile?
  nutrition           NutritionEntry[]
  water               WaterEntry[]
  weight              WeightEntry[]
  recommendations     Recommendation[]
  subscription        Subscription?
  articles            Article[]
  passwordResetTokens PasswordResetToken[]
  tempPasswords       TempPassword[]
  auditLogs           AuditLog[]
  SupportTicket       SupportTicket[]
}

model Profile {
  id                 String         @id @default(cuid())
  user               User           @relation(fields: [userId], references: [id])
  userId             String         @unique
  gender             String?
  birthDate          DateTime?
  heightCm           Int?
  currentWeightKg    Float?
  targetWeightKg     Float?
  goal               GoalType?
  activityLevel      ActivityLevel?
  dietaryPreferences String[]

  // Quiz-specific fields
  dietPlan            String?
  mealsPerDay         Int?
  skipBreakfast       Boolean?
  snackBetweenMeals   Boolean?
  fastFoodFrequency   String?
  cookAtHomeFrequency String?
  sleepHours          Float?
  exerciseRegularly   Boolean?
  wakeUpTime          String?
  dinnerTime          String?
  foodAllergies       String[]
  avoidedFoods        String[]
  mealComplexity      String?
  tryNewFoods         Boolean?
  cookingTimeMinutes  Int?
  eatWhenStressed     Boolean?
  mainMotivation      String?
  stressLevel         Int?
  comfortSource       String?
  routineConfidence   Int?
  dailyWaterMl        Int?
  wantReminders       Boolean?
  trackActivity       Boolean?
  connectHealthApp    Boolean?
  theme               String?

  // Calculated fields
  bmi                 Float?
  bmr                 Float?
  tdee                Float?
  recommendedCalories Float?

  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())
}

model QuizProfile {
  id     String @id @default(cuid())
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String @unique

  // Tracking fields
  clientId String?
  version  Int     @default(1)

  // Raw quiz answers (JSON)
  answers Json

  // Normalized fields
  dietPlan           String?
  heightCm           Float?
  weightKg           Float?
  bmi                Float?
  goalType           String?
  goalDeltaKg        Float?
  etaMonths          Int?
  mealsPerDay        Int?
  cookingTimeMinutes Int?
  exerciseRegularly  Boolean?

  // Metadata
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId])
  @@index([clientId])
}

model QuizLead {
  id          String   @id @default(cuid())
  email       String
  clientId    String   @default("")
  captureType String?
  step        Int?
  metadata    Json?
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  userId      String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([email, clientId])
  @@index([email])
  @@index([clientId])
  @@index([captureType])
  @@index([createdAt])
  @@index([userId])
}

model NutritionEntry {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  date      DateTime
  mealType  String
  food      String
  calories  Int
  protein   Float
  fat       Float
  carbs     Float
  createdAt DateTime @default(now())

  @@index([userId, date])
}

model WaterEntry {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  date      DateTime
  amountMl  Int
  createdAt DateTime @default(now())

  @@index([userId, date])
}

model WeightEntry {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  date      DateTime
  weightKg  Float
  note      String?
  createdAt DateTime @default(now())

  @@index([userId, date])
}

model Recommendation {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  date      DateTime @default(now())
  title     String
  body      String
  createdAt DateTime @default(now())

  @@index([userId, date])
}

// Admin/Support/Settings

enum TicketStatus {
  OPEN
  IN_PROGRESS
  WAITING_FOR_USER
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model SupportTicket {
  id              String           @id @default(cuid())
  user            User?            @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId          String?
  subject         String
  status          TicketStatus     @default(OPEN)
  priority        TicketPriority   @default(MEDIUM)
  assignedTo      String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  lastUserReplyAt DateTime?
  messages        SupportMessage[]

  @@index([status])
  @@index([priority])
  @@index([assignedTo])
  @@index([createdAt])
}

model SupportMessage {
  id          String        @id @default(cuid())
  ticket      SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  ticketId    String
  authorType  String
  authorId    String?
  body        String
  attachments Json?
  createdAt   DateTime      @default(now())

  @@index([ticketId])
}

model Setting {
  key       String   @id
  value     Json
  updatedBy String?
  updatedAt DateTime @default(now()) @updatedAt
}

model EmailTemplate {
  id        String   @id @default(cuid())
  key       String
  version   Int      @default(1)
  subject   String
  html      String   @db.Text
  createdBy String?
  createdAt DateTime @default(now())

  @@unique([key, version])
  @@index([key])
}

// Subscriptions

enum SubscriptionStatus {
  ACTIVE
  TRIALING
  CANCELED
  PAST_DUE
  INCOMPLETE
  INCOMPLETE_EXPIRED
  UNPAID
}

enum SubscriptionPlan {
  MONTHLY
  QUARTERLY
  ANNUAL
}

model Subscription {
  id                   String             @id @default(cuid())
  user                 User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId               String             @unique
  stripeCustomerId     String             @unique
  stripeSubscriptionId String             @unique
  stripePriceId        String
  plan                 SubscriptionPlan
  status               SubscriptionStatus
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  cancelAtPeriodEnd    Boolean            @default(false)
  canceledAt           DateTime?
  trialStart           DateTime?
  trialEnd             DateTime?
  metadata             Json?
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt

  @@index([status])
}

// Catalog

model MealTemplate {
  id                 String   @id @default(cuid())
  name               String
  category           String
  dietPlans          String[]
  calories           Int
  protein            Float
  fat                Float
  carbs              Float
  cookingTimeMinutes Int
  complexity         String
  allergens          String[]
  avoidedIngredients String[]
  ingredients        String[]
  instructions       String?
  servings           Int      @default(1)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@index([category])
}

model FoodItem {
  id               String   @id @default(cuid())
  name             String
  brand            String?
  category         String
  caloriesPer100g  Int
  proteinPer100g   Float
  fatPer100g       Float
  carbsPer100g     Float
  fiberPer100g     Float?
  sugarPer100g     Float?
  servingSize      String
  servingSizeGrams Float?
  barcode          String?
  verified         Boolean  @default(false)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([name])
  @@index([category])
  @@index([barcode])
}

// Articles, Password reset, Audit

model Article {
  id          String    @id @default(cuid())
  title       String
  slug        String    @unique
  excerpt     String?
  content     String
  category    String
  coverImage  String?
  tags        String[]
  published   Boolean   @default(false)
  publishedAt DateTime?
  viewCount   Int       @default(0)
  author      User      @relation(fields: [authorId], references: [id])
  authorId    String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([slug])
  @@index([category])
  @@index([published])
  @@index([authorId])
}

model PasswordResetToken {
  id        String    @id @default(cuid())
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  tokenHash String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([userId])
  @@index([tokenHash])
  @@index([expiresAt])
}

model TempPassword {
  id        String    @id @default(cuid())
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  hash      String
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([userId])
  @@index([expiresAt])
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  action    String
  entity    String
  entityId  String?
  metadata  Json?
  createdAt DateTime @default(now())
  User      User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([createdAt])
  @@map("audit_logs")
}

model ProcessedWebhookEvent {
  id          String   @id // Stripe event.id
  eventType   String
  processedAt DateTime @default(now())

  @@index([processedAt])
  @@map("processed_webhook_events")
}
